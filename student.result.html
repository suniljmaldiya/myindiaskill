<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Result - Green Valley High School</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
body {
  font-family: "Poppins", Arial, sans-serif;
  background: linear-gradient(to bottom right, #e8f5e9, #f0f2f5);
  margin: 0; padding: 0;
}
header {
  text-align: center;
  padding: 20px;
  background: #4CAF50;
  color: white;
  box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}
.result-card {
  background: white;
  max-width: 750px;
  margin: 30px auto;
  padding: 25px;
  border-radius: 14px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}
.result-card h2, .result-card h3 {
  text-align: center;
  color: #333;
}
#selector {
  display: flex;
  flex-direction: column;
  gap: 15px;
  align-items: center;
}
label {
  font-weight: bold;
  color: #333;
}
select, input {
  width: 90%;
  max-width: 420px;
  height: 45px;
  font-size: 16px;
  border-radius: 10px;
  border: 1px solid #ccc;
  padding: 0 10px;
  transition: all 0.2s ease;
}
select:focus, input:focus {
  outline: none;
  border-color: #4CAF50;
  box-shadow: 0 0 10px rgba(76,175,80,0.3);
}
button {
  padding: 12px 28px;
  font-size: 17px;
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  margin-top: 10px;
  transition: background 0.2s ease, transform 0.2s;
}
button:hover {
  background: #2E7D32;
  transform: scale(1.05);
}

.student-info p, .extra-info p {
  background: #e0f7fa;
  padding: 8px;
  border-radius: 6px;
  margin: 0 0 6px 0;
}
.marks-section {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.subject-bar {
  display: flex;
  align-items: center;
  gap: 10px;
}
.subject-bar-name {
  width: 130px;
  font-weight: bold;
  color: #333;
}
.subject-bar-value {
  flex: 1;
  height: 25px;
  background: #ccc;
  border-radius: 8px;
  position: relative;
}
.subject-bar-fill {
  height: 100%;
  border-radius: 8px;
  text-align: right;
  padding-right: 5px;
  color: white;
  font-weight: bold;
  line-height: 25px;
}
.badge {
  display: inline-block;
  margin-top: 15px;
  padding: 8px 16px;
  border-radius: 12px;
  font-weight: bold;
  color: white;
}
.print-btn {
  display: block;
  margin: 25px auto 0 auto;
  background: #2196F3;
}
.print-btn:hover { background:#0b7dda; }
@media(max-width:700px){
  .result-card { width: 95%; padding: 15px; }
  .subject-bar-name { width: 90px; font-size: 14px; }
  .subject-bar-fill { font-size: 14px; }
}
</style>
</head>
<body>

<header>
  <h1>Green Valley High School</h1>
  <h2>Student Result Portal</h2>
</header>

<div class="result-card">
  <div id="selector">
    <h3>üîç Search Student Result</h3>

    <label for="year">Year:</label>
    <select id="year" onchange="updateSemesterOptions()">
      <option value="">Select Year</option>
      <option value="2022">2022</option>
      <option value="2023">2023</option>
      <option value="2024">2024</option>
      <option value="2025">2025</option>
    </select>

    <label for="semester">Semester:</label>
    <select id="semester">
      <option value="">Select Semester</option>
      <option value="1">1st Semester</option>
      <option value="2">2nd Semester</option>
    </select>

    <label for="class">Class:</label>
    <select id="class">
      <option value="">Select Class</option>
      <option value="1">1</option><option value="2">2</option>
      <option value="3">3</option><option value="4">4</option>
      <option value="5">5</option><option value="6">6</option>
      <option value="7">7</option><option value="8">8</option>
      <option value="9">9</option><option value="10">10</option>
    </select>

    <label for="section">Section:</label>
    <select id="section">
      <option value="">Select Section</option>
      <option value="A">A</option><option value="B">B</option><option value="C">C</option>
    </select>

    <label for="roll">Roll:</label>
    <input type="number" id="roll" placeholder="Enter Roll (1‚Äì50)" min="1" max="50">

    <button onclick="showResult()">View Result</button>
  </div>
</div>

<div id="resultGrid" class="result-card" style="display:none;"></div>

<script>
// ========== Subject Setup ==========
function getSubjects(cls) {
  if (cls <= 5) return ["Math", "English", "Bangla", "Science", "ICT"];
  else return ["Math", "English", "Bangla", "Physics", "Chemistry", "Biology", "ICT", "History", "Geography", "Economics"];
}

// ========== Semester Filter ==========
function updateSemesterOptions(){
  const year = document.getElementById("year").value;
  const semester = document.getElementById("semester");
  semester.innerHTML = "";
  const opt1 = new Option("1st Semester", "1");
  semester.appendChild(opt1);
  if (year !== "2025") {
    const opt2 = new Option("2nd Semester", "2");
    semester.appendChild(opt2);
  }
}

// ========== Generate 1500 Students ==========
if (!localStorage.getItem("studentsData")) {
  const sections = ["A","B","C"];
  const students = [];
  for (let cls=1; cls<=10; cls++) {
    for (const sec of sections) {
      for (let roll=1; roll<=50; roll++) {
        const marks = {};
        getSubjects(cls).forEach(sub => marks[sub] = Math.floor(Math.random()*41)+60);
        students.push({
          id: `${cls}${sec}${roll}`,
          name: `Student_${cls}${sec}${roll}`,
          class: cls,
          section: sec,
          roll: roll,
          marks,
          presentDays: Math.floor(Math.random()*20)+100
        });
      }
    }
  }
  localStorage.setItem("studentsData", JSON.stringify(students));
}

const students = JSON.parse(localStorage.getItem("studentsData"));

// ========== Color + Badge Helpers ==========
function getColor(mark){ return mark>=80 ? "#4CAF50" : mark>=60 ? "#FF9800" : "#F44336"; }
function getBadge(p){
  if(p>=90) return `<span class="badge" style="background:#4CAF50;">Excellent üèÜ</span>`;
  if(p>=75) return `<span class="badge" style="background:#2196F3;">Very Good ‚≠ê</span>`;
  if(p>=60) return `<span class="badge" style="background:#FF9800;">Good üëç</span>`;
  return `<span class="badge" style="background:#F44336;">Needs Improvement ‚ö†Ô∏è</span>`;
}

// ========== Show Result ==========
function showResult(){
  const cls = parseInt(document.getElementById("class").value);
  const sec = document.getElementById("section").value;
  const roll = parseInt(document.getElementById("roll").value);
  const year = document.getElementById("year").value;
  const semester = document.getElementById("semester").value;

  if(!cls || !sec || !roll || !year || !semester){ alert("Please fill all fields."); return; }

  const student = students.find(s=>s.class==cls && s.section==sec && s.roll==roll);
  if(!student){ alert("Student not found!"); return; }

  // --------- Pick marks properly ----------
  let marksObj;
  if(student.marks[year] && student.marks[year][semester]){
    marksObj = student.marks[year][semester];
  } else if(typeof student.marks[year]==="object" && !Array.isArray(student.marks[year])){
    marksObj = student.marks[year]; // older format
  } else {
    // If no marks found, pick latest available
    const years = Object.keys(student.marks);
    const latestYear = years.sort().reverse()[0];
    const semesters = Object.keys(student.marks[latestYear]);
    const latestSem = semesters.sort().reverse()[0];
    marksObj = student.marks[latestYear][latestSem];
  }

  let total=0, marksHTML="";
  for(const [sub,mark] of Object.entries(marksObj)){
    total+=mark;
    marksHTML+=`
    <div class="subject-bar">
      <div class="subject-bar-name">${sub}</div>
      <div class="subject-bar-value">
        <div class="subject-bar-fill" style="width:${mark}%; background:${getColor(mark)};">${mark}/100</div>
      </div>
    </div>`;
  }

  const percentage=(total/Object.keys(marksObj).length).toFixed(2);

  const sectionStudents = students.filter(s=>s.class==cls && s.section==sec);
  const top = sectionStudents.reduce((a,b)=>( 
    Object.values(a.marks).flatMap(o=>Object.values(o)).reduce((x,y)=>x+y,0) >
    Object.values(b.marks).flatMap(o=>Object.values(o)).reduce((x,y)=>x+y,0) ? a : b 
  ));

  const resultGrid=document.getElementById("resultGrid");
  document.getElementById("selector").style.display="none";
  resultGrid.style.display="block";
  resultGrid.innerHTML=`
    <h2>${student.name}</h2>
    <h3>Class ${student.class}-${student.section}, Roll ${student.roll}</h3>
    <div class="student-info">
      <p><strong>ID:</strong> ${student.id}</p>
      <p><strong>Year:</strong> ${year}</p>
      <p><strong>Semester:</strong> ${semester==1?"1st":"2nd"}</p>
      <p><strong>Attendance:</strong> ${student.presentDays}/120 days</p>
    </div>
    <div class="extra-info">
      <p><strong>Total Students:</strong> ${sectionStudents.length}</p>
      <p><strong>Top Student:</strong> ${top.name} (Roll ${top.roll})</p>
    </div>
    <h3>Subject Marks</h3>
    <div class="marks-section">${marksHTML}</div>
    <p><strong>Total:</strong> ${total}/${Object.keys(marksObj).length*100}</p>
    <p><strong>Percentage:</strong> ${percentage}%</p>
    ${getBadge(percentage)}
    <button class="print-btn" onclick="downloadPDF()">Download PDF</button>
  `;
}

// ========== PDF Download ==========
function downloadPDF(){
  const element=document.getElementById("resultGrid");
  const opt={
    margin:0.5,
    filename:"student-result.pdf",
    image:{type:"jpeg",quality:0.98},
    html2canvas:{scale:2},
    jsPDF:{unit:"in",format:"a4",orientation:"portrait"}
  };
  html2pdf().set(opt).from(element).save();
}
</script>

</body>
</html>
