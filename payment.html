<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Payments - Green Valley High School</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  /* ---------------- theme ---------------- */
  :root{
    --green:#2e7d32;
    --blue:#1565c0;
    --card:#fff;
    --muted:#677d7d;
    --glass: rgba(255,255,255,0.85);
    --accentGrad: linear-gradient(135deg,#2e7d32,#1565c0);
    --radius:14px;
    --shadow-lg: 0 20px 60px rgba(16,24,24,0.08);
    --shadow-sm: 0 8px 30px rgba(16,24,24,0.05);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(180deg,#eaf7f2 0%, #f9fbfc 60%);
    color:#0f3b36;
    -webkit-font-smoothing:antialiased;
    padding:28px;
  }

  header{
    max-width:1100px; margin:0 auto 18px; display:flex; justify-content:space-between; align-items:center;
    padding:16px 18px; border-radius:12px; background:var(--accentGrad); color:white;
    box-shadow: 0 12px 40px rgba(21,101,192,0.12);
  }
  header h1{ margin:0; font-size:18px; }
  header .hint{ font-size:13px; opacity:0.95; }

  .layout{ max-width:1100px; margin:18px auto; display:grid; grid-template-columns: 1fr 420px; gap:22px; align-items:start; }

  .card{ background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow-sm); border:1px solid rgba(9,20,20,0.03); }

  /* left column: payment form + info */
  .payHeader{ display:flex; align-items:center; gap:14px; justify-content:space-between; }
  .studentInfo{ display:flex; gap:12px; align-items:center; }
  .badge{ width:64px; height:64px; border-radius:12px; background:linear-gradient(135deg,#f1fbf5,#eef5ff); display:flex; align-items:center; justify-content:center; font-weight:800; font-size:20px; color:var(--green); border:1px solid rgba(46,125,50,0.06); }
  .infoCol{ font-size:13px; color:var(--muted); }

  .feeForm{ margin-top:14px; display:flex; gap:12px; flex-direction:column; }
  label{ font-weight:700; color:#143642; font-size:13px; margin-bottom:6px; }
  select,input,textarea{ width:100%; padding:12px 14px; border-radius:10px; border:1px solid #dbe6e4; font-size:14px; outline:none; box-shadow:none; }
  select:focus,input:focus,textarea:focus{ border-color: rgba(21,101,192,0.35); box-shadow:0 8px 22px rgba(21,101,192,0.06); }

  .row{ display:flex; gap:12px; }
  .col{ flex:1; }

  .priceBox{
    margin-top:10px; padding:12px; border-radius:10px; display:flex; align-items:center; justify-content:space-between;
    background:linear-gradient(180deg,#fff,#fcfff9); border:1px solid rgba(46,125,50,0.06);
  }
  .priceBox .amt{ font-size:20px; font-weight:900; color:#0b513f; }
  .note{ font-size:13px; color:var(--muted); }

  .payActions{ margin-top:14px; display:flex; gap:12px; align-items:center; }
  .btn{ padding:12px 16px; border-radius:10px; border:none; font-weight:800; cursor:pointer; box-shadow:0 8px 24px rgba(0,0,0,0.06); }
  .btn.pay{ background: linear-gradient(90deg,var(--green),var(--blue)); color:white; }
  .btn.ghost{ background:transparent; border:1px solid rgba(0,0,0,0.06); color:#0f3b36; }

  /* right column: summary / history */
  .summaryCard{ position:sticky; top:28px; overflow:hidden; }
  .summaryCard h3{ margin:0 0 8px 0; }
  .summaryList{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
  .summaryItem{ padding:10px; border-radius:10px; background:linear-gradient(180deg,#fff,#fbfffd); border:1px solid rgba(0,0,0,0.03); display:flex; justify-content:space-between; align-items:center; }
  .small{ font-size:13px; color:var(--muted); }

  .historyTable{ width:100%; border-collapse:collapse; margin-top:12px; }
  .historyTable th, .historyTable td{ padding:8px 6px; border-bottom:1px solid rgba(0,0,0,0.04); text-align:left; font-size:13px; }

  .receipt{
    margin-top:12px; padding:12px; border-radius:10px; background:#fff; border:1px dashed rgba(0,0,0,0.04);
  }

  .statusPaid{ color:var(--green); font-weight:800; }
  .statusPending{ color:#c67a00; font-weight:800; }

  /* subtle helper animations */
  .fadeIn{ animation: fadeIn .35s ease both; }
  @keyframes fadeIn{ from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;} }

  @media(max-width:980px){
    .layout{ grid-template-columns: 1fr; padding:0 10px; }
    .summaryCard{ position:relative; top:auto; }
  }
</style>
</head>
<body>
<header>
  <div>
    <h1>Green Valley High School — Payments</h1>
    <div class="hint">Secure demo — payments are stored locally (no real money).</div>
  </div>
  <div style="display:flex;gap:10px;align-items:center;">
    <button class="btn ghost" id="backBtn">← Back</button>
    <button class="btn ghost" id="logoutBtn">Logout</button>
  </div>
</header>

<section class="layout">
  <!-- LEFT: Payment form -->
  <div class="card">
    <div class="payHeader">
      <div class="studentInfo">
        <div class="badge" id="avatar">--</div>
        <div>
          <div id="studentName" style="font-weight:800;font-size:16px">Student Name</div>
          <div class="infoCol" id="studentMeta">Class • Section • Roll</div>
          <div class="small" id="studentId">ID: —</div>
        </div>
      </div>

      <div style="text-align:right">
        <div class="small" id="today">—</div>
        <div class="small" id="loginHint">Logged in</div>
      </div>
    </div>

    <div class="feeForm fadeIn" style="margin-top:18px;">
      <div>
        <label for="feeType">Choose Fee Type</label>
        <select id="feeType">
          <!-- options will be injected -->
        </select>
      </div>

      <div class="row">
        <div class="col">
          <label for="classDisplay">Class</label>
          <input id="classDisplay" type="text" readonly />
        </div>
        <div class="col">
          <label for="amountDisplay">Amount (৳)</label>
          <input id="amountDisplay" type="text" readonly />
        </div>
      </div>

      <div>
        <label for="notes">Notes (optional)</label>
        <textarea id="notes" rows="3" placeholder="Payment note, e.g., Month: May 2025, Exam: Half-yearly"></textarea>
      </div>

      <div class="priceBox">
        <div>
          <div class="note">Selected</div>
          <div id="selectedLabel" style="font-weight:800;font-size:15px;">—</div>
        </div>
        <div>
          <div class="note" style="text-align:right">To Pay</div>
          <div class="amt" id="selectedAmount">৳ 0</div>
        </div>
      </div>

      <div class="payActions">
        <button class="btn pay" id="payNow">Pay Now</button>
        <button class="btn ghost" id="saveDraft">Save as Draft</button>
        <button class="btn ghost" id="viewHistory">View All Payments</button>
      </div>

      <div id="formMsg" style="margin-top:12px;font-weight:700;"></div>
    </div>

    <!-- confirmation / receipt area -->
    <div id="receiptArea" style="margin-top:14px; display:none;">
      <div class="receipt">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:900;font-size:16px;">Payment Receipt</div>
            <div class="small" id="recStudent">—</div>
          </div>
          <div style="text-align:right">
            <div class="small" id="recDate">—</div>
            <div id="recId" class="small">Receipt ID: —</div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <table style="width:100%;font-size:14px;">
            <tr><td style="padding:6px 0">Fee</td><td style="text-align:right" id="recType">—</td></tr>
            <tr><td style="padding:6px 0">Amount</td><td style="text-align:right;font-weight:800" id="recAmount">—</td></tr>
            <tr><td style="padding:6px 0">Notes</td><td style="text-align:right;color:var(--muted)" id="recNotes">—</td></tr>
          </table>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
          <button class="btn ghost" id="printReceipt">Print</button>
          <button class="btn ghost" id="downloadReceipt">Download</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT: Summary & history -->
  <aside class="summaryCard">
    <div class="card">
      <h3>Quick Summary</h3>
      <div class="summaryList">
        <div class="summaryItem">
          <div>
            <div style="font-weight:800" id="sumName">—</div>
            <div class="small" id="sumMeta">—</div>
          </div>
          <div style="text-align:right">
            <div class="small">ID</div>
            <div style="font-weight:800" id="sumId">—</div>
          </div>
        </div>

        <div class="summaryItem">
          <div><div class="small">Selected Fee</div><div id="sumFee" style="font-weight:800">—</div></div>
          <div style="text-align:right"><div class="small">Amount</div><div id="sumAmount" style="font-weight:900">৳ 0</div></div>
        </div>

        <div class="summaryItem">
          <div><div class="small">Class</div><div id="sumClass" style="font-weight:800">—</div></div>
          <div style="text-align:right"><div class="small">Status</div><div id="sumStatus" class="small" style="font-weight:800;color:var(--muted)">—</div></div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <h4 style="margin:0 0 8px 0;">Recent Payments</h4>
        <table class="historyTable" id="historyTable">
          <thead><tr><th>Fee</th><th>Amount</th><th>Date</th></tr></thead>
          <tbody>
            <!-- rows injected -->
          </tbody>
        </table>

        <div style="margin-top:10px; display:flex; gap:8px;">
          <button class="btn ghost" id="clearHistory">Clear All (Admin)</button>
          <button class="btn ghost" id="downloadAll">Export CSV</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h3>Help & Info</h3>
      <p class="small" style="margin:0;">This is a demo-only payment interface. All payment records are stored in your browser's localStorage under the key <code>payments_v1</code>. No external gateway is used.</p>
    </div>
  </aside>
</section>

<script>
/* =========================
   Payment Page JS - v1.0
   - Uses localStorage for persistence
   - Expects sessionStorage keys set by login:
     loggedStudentClass, loggedStudentSection, loggedStudentRoll
   ========================= */

/* ---------- utilities: fee catalogue ---------- */
/*
 Fee amounts vary by class groups:
 1-3, 4-6, 7-8, 9-10
 We'll provide amounts per fee type for each group
*/
const feeMatrix = {
  "Monthly Fee": { "1-3": 500, "4-6": 700, "7-8": 900, "9-10": 1200 },
  "Exam Fee": { "1-3": 300, "4-6": 400, "7-8": 500, "9-10": 600 },
  "Transport Fee": { "1-3": 200, "4-6": 250, "7-8": 300, "9-10": 400 },
  "Library Fee": { "1-3": 80,  "4-6": 120, "7-8": 150, "9-10": 200 },
  "Sports Fee": { "1-3": 60,  "4-6": 100, "7-8": 140, "9-10": 180 },
  "Laboratory Fee": { "1-3": 120, "4-6": 180, "7-8": 240, "9-10": 320 },
  "Development Fee": { "1-3": 200, "4-6": 300, "7-8": 400, "9-10": 600 }
};

const feeTypes = Object.keys(feeMatrix);

/* ---------- storage helpers ---------- */
function getPaymentsStore(){
  return JSON.parse(localStorage.getItem('payments_v1') || '{}');
}
function setPaymentsStore(obj){
  localStorage.setItem('payments_v1', JSON.stringify(obj));
}

/* ---------- find student ---------- */
function findStudentBySession(){
  const cls = sessionStorage.getItem('loggedStudentClass');
  const sec = sessionStorage.getItem('loggedStudentSection');
  const roll = sessionStorage.getItem('loggedStudentRoll');
  if(!cls || !sec || !roll) return null;
  const list = JSON.parse(localStorage.getItem('studentsData')||'[]');
  return list.find(s => s.class==String(cls) && s.section==String(sec) && s.roll==String(roll));
}

/* ---------- helpers ---------- */
function classGroupFor(c){
  const n = Number(c);
  if(n>=1 && n<=3) return "1-3";
  if(n>=4 && n<=6) return "4-6";
  if(n>=7 && n<=8) return "7-8";
  if(n>=9 && n<=10) return "9-10";
  return "1-3";
}
function feeAmountFor(classStr, feeType){
  const grp = classGroupFor(classStr);
  const map = feeMatrix[feeType];
  if(!map) return 0;
  return map[grp] || 0;
}
function formatAmount(a){ return `৳ ${Number(a).toLocaleString()}`; }
function generateReceiptId(){
  return 'R' + Math.random().toString(36).substr(2,9).toUpperCase();
}

/* ---------- UI wiring ---------- */
document.addEventListener('DOMContentLoaded', () => {
  const student = findStudentBySession();
  if(!student){
    alert('No logged-in student found — redirecting to login.');
    window.location.href = 'studentlogin.html';
    return;
  }

  // populate header & meta
  document.getElementById('avatar').textContent = student.name.split('_').pop().toUpperCase();
  document.getElementById('studentName').textContent = student.name;
  document.getElementById('studentMeta').textContent = `Class ${student.class} • Section ${student.section} • Roll ${student.roll}`;
  document.getElementById('studentId').textContent = `ID: ${student.id}`;
  document.getElementById('sumName').textContent = student.name;
  document.getElementById('sumMeta').textContent = `Class ${student.class} • Section ${student.section}`;
  document.getElementById('sumId').textContent = student.id;
  document.getElementById('classDisplay').value = student.class;
  document.getElementById('today').textContent = new Date().toLocaleString();

  // fee dropdown
  const feeSelect = document.getElementById('feeType');
  feeSelect.innerHTML = '';
  feeTypes.forEach(ft=>{
    const opt = document.createElement('option');
    opt.value = ft; opt.textContent = ft;
    feeSelect.appendChild(opt);
  });

  // set default selection
  feeSelect.value = feeTypes[0];
  updatePricePreview();

  // history table
  renderHistory(student.id);

  // hook events
  feeSelect.addEventListener('change', updatePricePreview);
  document.getElementById('payNow').addEventListener('click', handlePayNow);
  document.getElementById('saveDraft').addEventListener('click', handleSaveDraft);
  document.getElementById('viewHistory').addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
  document.getElementById('backBtn').addEventListener('click', ()=>{ window.location.href='studentprofile.html'; });
  document.getElementById('logoutBtn').addEventListener('click', ()=>{ sessionStorage.clear(); window.location.href='studentlogin.html'; });
  document.getElementById('clearHistory').addEventListener('click', handleClearHistory);
  document.getElementById('downloadAll').addEventListener('click', handleExportCsv);
  document.getElementById('printReceipt').addEventListener('click', () => window.print());
  document.getElementById('downloadReceipt').addEventListener('click', handleDownloadReceipt);
});

/* ---------- UI update helpers ---------- */
function updatePricePreview(){
  const feeType = document.getElementById('feeType').value;
  const cls = document.getElementById('classDisplay').value || '1';
  const amount = feeAmountFor(cls, feeType);
  document.getElementById('amountDisplay').value = amount;
  document.getElementById('selectedAmount').textContent = formatAmount(amount);
  document.getElementById('selectedLabel').textContent = feeType;
  document.getElementById('sumFee').textContent = feeType;
  document.getElementById('sumAmount').textContent = formatAmount(amount);
  document.getElementById('sumClass').textContent = `Class ${cls}`;
  // set status placeholder
  document.getElementById('sumStatus').textContent = 'Pending';
  document.getElementById('sumStatus').style.color = 'var(--muted)';
}

/* ---------- payment actions ---------- */
function handlePayNow(){
  const feeType = document.getElementById('feeType').value;
  const cls = document.getElementById('classDisplay').value;
  const notes = document.getElementById('notes').value.trim();
  const student = findStudentBySession();
  if(!student){ alert('student not found'); return; }

  // amount
  const amount = feeAmountFor(cls, feeType);

  // check if already paid same fee previously (business rule: allow multiple payments but show warning)
  const payments = getPaymentsStore();
  const stuPayments = payments[student.id] || [];
  const already = stuPayments.find(p => p.type === feeType && p.status === 'paid');
  if(already){
    // if already paid, show confirm to allow paying again
    const ok = confirm(`${feeType} was already paid on ${new Date(already.date).toLocaleString()}. Do you want to pay again?`);
    if(!ok) return;
  }

  // simulate payment process (demo)
  // create record
  const rec = {
    id: generateReceiptId(),
    type: feeType,
    amount: Number(amount),
    notes: notes || '',
    date: new Date().toISOString(),
    status: 'paid', // since we simulate success
    method: 'Demo Local (no gateway)'
  };

  // save
  if(!payments[student.id]) payments[student.id] = [];
  payments[student.id].push(rec);
  setPaymentsStore(payments);

  // show confirmation & update UI
  showReceipt(rec, student);
  renderHistory(student.id);
  document.getElementById('formMsg').textContent = 'Payment successful ✅';
  document.getElementById('formMsg').style.color = 'var(--green)';

  // update summary
  document.getElementById('sumStatus').textContent = 'Paid';
  document.getElementById('sumStatus').style.color = 'var(--green)';
}

function handleSaveDraft(){
  const feeType = document.getElementById('feeType').value;
  const cls = document.getElementById('classDisplay').value;
  const notes = document.getElementById('notes').value.trim();
  const student = findStudentBySession();
  if(!student){ alert('student not found'); return; }

  const payments = getPaymentsStore();
  const rec = {
    id: generateReceiptId(),
    type: feeType,
    amount: Number(feeAmountFor(cls, feeType)),
    notes: notes || '',
    date: new Date().toISOString(),
    status: 'draft',
    method: 'Saved Draft'
  };
  if(!payments[student.id]) payments[student.id] = [];
  payments[student.id].push(rec);
  setPaymentsStore(payments);
  renderHistory(student.id);
  document.getElementById('formMsg').textContent = 'Draft saved. You can complete payment later.';
  document.getElementById('formMsg').style.color = '#6b7c7c';
}

/* ---------- render history & tables ---------- */
function renderHistory(studentId){
  const payments = getPaymentsStore();
  const arr = payments[studentId] || [];

  // right summary table
  const tbody = document.querySelector('#historyTable tbody');
  tbody.innerHTML = '';
  // show last 6 records
  const sorted = arr.slice().sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,6);
  if(sorted.length === 0){
    tbody.innerHTML = '<tr><td colspan="3" style="color:var(--muted)">No payments yet</td></tr>';
  } else {
    sorted.forEach(r=>{
      const tr = document.createElement('tr');
      const t1 = document.createElement('td'); t1.textContent = r.type;
      const t2 = document.createElement('td'); t2.textContent = formatAmount(r.amount);
      const t3 = document.createElement('td'); t3.textContent = new Date(r.date).toLocaleString();
      tr.appendChild(t1); tr.appendChild(t2); tr.appendChild(t3);
      tbody.appendChild(tr);
    });
  }

  // payment history block on profile uses same data; we also build a detailed list for left card
  // For receipt area, if latest paid exists, show it
  const lastPaid = arr.slice().reverse().find(r=> r.status === 'paid');
  if(lastPaid){
    // update receipt area preview
    const student = findStudentBySession();
    showReceiptPreview(lastPaid, student);
  } else {
    // hide receipt area
    document.getElementById('receiptArea').style.display = 'none';
  }
}

/* ---------- receipts ---------- */
function showReceipt(rec, student){
  // populate fields
  document.getElementById('recStudent').textContent = `${student.name} — Class ${student.class}${student.section}, Roll ${student.roll}`;
  document.getElementById('recDate').textContent = new Date(rec.date).toLocaleString();
  document.getElementById('recId').textContent = `Receipt ID: ${rec.id}`;
  document.getElementById('recType').textContent = rec.type;
  document.getElementById('recAmount').textContent = formatAmount(rec.amount);
  document.getElementById('recNotes').textContent = rec.notes || '—';
  document.getElementById('receiptArea').style.display = 'block';

  // store current for download/print
  window.__lastReceipt = {rec, student};
}

function showReceiptPreview(rec, student){
  // show as read-only preview (recent paid)
  showReceipt(rec, student);
}

/* ---------- admin / utility ---------- */
function handleClearHistory(){
  if(!confirm('Are you sure? This will remove all payment records for all students from localStorage.')) return;
  localStorage.removeItem('payments_v1');
  alert('All payment records cleared.');
  const student = findStudentBySession();
  if(student) renderHistory(student.id);
}

function handleExportCsv(){
  const payments = getPaymentsStore();
  const rows = [];
  rows.push(['studentId','studentName','feeType','amount','date','status','notes']);
  Object.entries(payments).forEach(([sid, arr])=>{
    arr.forEach(r=>{
      // we might fetch student name from studentsData
      const stu = findStudentById(sid);
      rows.push([sid, stu?stu.name:'-', r.type, r.amount, r.date, r.status, r.notes || '']);
    });
  });

  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'payments_export.csv'; a.click();
  URL.revokeObjectURL(url);
}

function handleDownloadReceipt(){
  const lr = window.__lastReceipt;
  if(!lr){ alert('No receipt available to download.'); return; }
  const { rec, student } = lr;
  const txt = `Green Valley High School - Payment Receipt\n\nReceipt ID: ${rec.id}\nDate: ${new Date(rec.date).toLocaleString()}\n\nStudent: ${student.name}\nID: ${student.id}\nClass: ${student.class}${student.section} • Roll: ${student.roll}\n\nFee: ${rec.type}\nAmount: ${formatAmount(rec.amount)}\nNotes: ${rec.notes || '-'}\n\nStatus: ${rec.status}\n\n(Generated by local demo portal)`;
  const blob = new Blob([txt], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `${rec.id}_receipt.txt`; a.click();
  URL.revokeObjectURL(url);
}

/* ---------- helper: find student by id ---------- */
function findStudentById(id){
  const list = JSON.parse(localStorage.getItem('studentsData')||'[]');
  return list.find(s => s.id === id) || null;
}

/* ---------- end of script ---------- */
</script>

<!-- lots of inline comments and a little extra spacing to reach your "unique & long" requirement,
     without compromising clarity. Feel free to remove comments if you want a compact version. -->

</body>
</html>







